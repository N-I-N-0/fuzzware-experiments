# Analyzing the Crash
The crash occurs in `snmp_ber_decode_type` after `snmp_ber_decode_string_len_buffer` was called, which corrupts the parsing cursor due to an untrusted size value within the community field being used.

> **Note**
> To replay the inputs in this directory, you may need to use the initial version of `fuzzware-emulator` and rebuild fuzzware. For instructions, see [here](https://github.com/fuzzware-fuzzer/fuzzware-experiments/tree/main/04-crash-analysis).

## Interactive Bug Triaging with known Bug
To interactively see this, set a breakpoint in snmp_ber_decode_type:
```
./run.sh -b snmp_ber_decode_type
```

Check the parsing cursor argument (first argument: `r0`) and continue execution until `snmp_ber_decode_type` follows a call to `snmp_ber_decode_string_len_buffer` or until `r0` shows the corrupted pointer address `0x38011364`.

```
ipdb> c
...
ipdb> uc.regs.r0
0x21000762
```

As this address will be read from for further decoding, a crash occurs.

## Bug details 

This bug is out of bound in the buffer from snmp packets, caused by unverified `length` value from packet 

The root caused function of this bug
```c
unsigned char *
snmp_ber_decode_string_len_buffer(unsigned char *buf, uint32_t *buff_len, const char **str, uint32_t *length)
{
    // length_bytes comes from one bit at unverified buffer 
    length_bytes = (uint8_t)(*buf++ & 0x7F);

    *length = (uint32_t)*buf++;
    for(i = 1; i < length_bytes/* used as loop condition */; ++i) {
      // causes huge length value 
      *length <<= 8;
      *length |= *buf++;
    }

    return buf + *length;
}
```

the scenario which trigger this bug  
```c
uint8_t *
snmp_message_decode(uint8_t *buf, uint32_t buf_len, snmp_header_t *header,
                    snmp_varbind_t *varbinds, uint32_t *varbind_num)
{
  // the out of bound pointer set to buf
  buf = snmp_ber_decode_string_len_buffer(buf, &buf_len, &header->community.community, &header->community.length);
  // denial of service when load data form buf 
  buf = snmp_ber_decode_type(buf, &buf_len, &type);
}
```

## Crash Log

Analysis the bug using log generated by fuzzware

```shell
# tail logs
Basic Block: addr= 0x00000000002088b4 (lr=0x20598f)
        >>> [ 0x002088b4 ] INVALID READ: addr= 0x0000000038011364 size=1 data=0x0000000000000000
Execution failed with error code: 6 -> Invalid memory read (UC_ERR_READ_UNMAPPED)

# 0x2089bc related to *length |= *buf++
# get the final length value 
❯ cat crash.log | grep 2089bc
        >>> Write: addr= 0x0000000020000c74 size=4 data=0x00001801 (pc 0x002089bc)
        >>> Write: addr= 0x0000000020000c74 size=4 data=0x00180104 (pc 0x002089bc)
        >>> Write: addr= 0x0000000020000c74 size=4 data=0x18010400 (pc 0x002089bc)
# 0x2089c6 related to *length = (uint32_t)*buf
# we cat get original buf pointer value 
❯ cat crash.log | grep 2089c6
Basic Block: addr= 0x00000000002089c6 (lr=0x20594f)
        >>> Write: addr= 0x0000000020000c70 size=4 data=0x20000f64 (pc 0x002089c6)
```

0x18010400 + 0x20000f64 == 0x38011364
